---
const cards = [
  { id: 1, color: "#FF6B6B", img: "https://images.unsplash.com/photo-1502781252888-9143ba7f074e?q=80&w=1471&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" },
  { id: 2, color: "#4ECDC4", img: "https://images.unsplash.com/photo-1542810634-71277d95dcbb?q=80&w=1470&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" },
  { id: 3, color: "#FFE66D", img: "https://images.unsplash.com/photo-1695655211999-e4d4ac25a4e5?q=80&w=1474&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" },
  { id: 4, color: "#1A535C", img: "https://plus.unsplash.com/premium_photo-1663099750497-11448691bc2f?q=80&w=1470&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" },
];
---

<section class="stack-container">
  <div class="cards-wrapper">
    {cards.map((card, index) => (
      <div class="card" style={`z-index: ${cards.length - index}; background-image: url(${card.img})`}>
        <div class="card-content">
        </div>
      </div>
    ))}
  </div>
</section>

<script>
  import gsap from "gsap";
  import ScrollTrigger from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  const container = document.querySelector(".stack-container");
  const cards = gsap.utils.toArray(".card") as HTMLElement[];

  // Configuración inicial
  gsap.set(cards, {
    y: (i) => i * 15,
    scale: (i) => 1 - i * 0.05,
    transformOrigin: "center top",
  });

  // Use the container's parent (wrapper) as the trigger for the timeline length
  // The container itself is sticky, so it stays in view.
  // We want the animation to progress as we scroll through the wrapper.
  const wrapper = container?.parentElement;

  if (wrapper) {
    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: wrapper,
        start: "top top",
        end: "bottom bottom",
        scrub: 1,
        invalidateOnRefresh: true,
      },
    });

    // Animación del Stack
    cards.forEach((card, i) => {
      if (i === cards.length - 1) return;

      tl.to(card, {
        yPercent: -120,
        opacity: 0,
        rotation: Math.random() * 10 - 5,
        duration: 1,
        ease: "power2.inOut"
      })
      .to(cards.slice(i + 1), {
        y: (index) => index * 15,
        scale: (index) => 1 - index * 0.05,
        duration: 1,
        ease: "power2.inOut"
      }, "<");
    });
  }
</script>

<style>
  .stack-container {
    width: 100%;
    height: 100vh;
    display: flex;
    justify-content: flex-end; /* Desktop: Align right */
    align-items: center;
    overflow: hidden;
    position: sticky;
    top: 0;
    align-self: start; /* Important for sticky in grid */
    z-index: 0;
    pointer-events: none;
    padding-right: 15vw; /* Spacing from right */
  }

  .cards-wrapper {
    position: relative;
    width: 700px;
    height: 500px;
  }

  /* Mobile Styles */
  @media (max-width: 768px) {
    .stack-container {
      justify-content: center; /* Center horizontally */
      align-items: flex-end; /* Align bottom */
      padding-right: 0;
      padding-bottom: 0;
    }

    .cards-wrapper {
      width: 350px; /* Keep original width for mobile */
      /* Mobile: Position at bottom, 2/3 visible.
         This means 1/3 hidden below. */
      transform: translateY(33%);
      margin-bottom: 2rem; /* Slight adjustment from edge */
    }
  }

  .card {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 20px;
    background-size: cover;
    background-position: center;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: flex-end;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.1);
    will-change: transform, opacity;
  }

  .card-content {
    width: 100%;
    padding: 20px;
    background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
    color: white;
  }

  h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: bold;
  }
</style>
